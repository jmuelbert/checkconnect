---
# SPDX-FileCopyrightText: Jürgen Mülbert
# SPDX-License-Identifier: EUPL-1.2

name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - develop
      - feature/**
      - bugfix/**

permissions:
  contents: read
  issues: write
  pull-requests: write

env:
  PYTHON_VERSION_FILE: .python-version
  PACKAGE_NAME: checkconnect

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: Validate Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 15

    permissions:
      contents: read
      pull-requests: write
      security-events: write

    steps:
      - name: 🔒 Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: 📥 Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🔎 Dependency Review
        id: review
        uses: actions/dependency-review-action@v4
        with:
          comment-summary-in-pr: always
          fail-on-severity: moderate
          retry-on-snapshot-warnings: true
          config-file: .github/dependency-review-config.yml

      - name: 📊 Generate Report
        if: always()
        env:
          DEPENDENCY_CHANGES: ${{ steps.review.outputs.dependency-changes }}
          VULNERABLE_CHANGES: ${{ steps.review.outputs.vulnerable-changes }}
          LICENSE_CHANGES: ${{ steps.review.outputs.invalid-license-changes }}
          DENIED_CHANGES: ${{ steps.review.outputs.denied-changes }}
        uses: actions/github-script@v7 # Use tag instead of SHA
        with:
          script: |
            const outputs = {
              dependencyChanges: JSON.parse(process.env.DEPENDENCY_CHANGES || '[]'),
              vulnerableChanges: JSON.parse(process.env.VULNERABLE_CHANGES || '[]'),
              licenseChanges: JSON.parse(process.env.LICENSE_CHANGES || '[]'),
              deniedChanges: JSON.parse(process.env.DENIED_CHANGES || '[]'),
            };

            let report = '## 📋 Dependency Review Report\n\n';

            // Dependency Summary
            report += `### 📑 Summary\n`;
            report += `- Total Changes: ${outputs.dependencyChanges.length}\n`;
            report += `- Vulnerable Changes: ${outputs.vulnerableChanges.length}\n`;
            report += `- License Issues: ${outputs.licenseChanges.length}\n`;
            report += `- Denied Changes: ${outputs.deniedChanges.length}\n\n`;

            // Vulnerabilities
            if (outputs.vulnerableChanges.length > 0) {
              report += '### ⚠️ Vulnerable Changes\n\n';
              outputs.vulnerableChanges.forEach(change => {
              report += `- **${change.package.name}@${change.package.version}**: ${change.advisory.title}\n`;
              report += `  - Severity: ${change.advisory.severity}\n`;
              report += `  - Advisory: [${change.advisory.url}](${change.advisory.url})\n\n`;
              });
            } else {
              report += '### ✅ No Vulnerable Changes Found\n\n';
            }

            // License Issues
            if (outputs.licenseChanges.length > 0) {
              report += '### 🚫 License Issues\n\n';
              outputs.licenseChanges.forEach(change => {
              report += `- **${change.package.name}@${change.package.version}**: ${change.license}\n`;
              report += `  - Allowed Licenses: ${change.allowedLicenses.join(', ')}\n\n`;
              });
            } else {
              report += '### ✅ No License Issues Found\n\n';
            }

            // Denied Changes
            if (outputs.deniedChanges.length > 0) {
              report += '### ❌ Denied Changes\n\n';
              outputs.deniedChanges.forEach(change => {
              report += `- **${change.package.name}@${change.package.version}**: ${change.reason}\n`;
              });
            } else {
              report += '### ✅ No Denied Changes Found\n\n';
            }

            // Post Report
            if (context.payload.pull_request) {
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.payload.pull_request.number,
                body: report
              });
            }


  validate-pr:
    name: Validate PR
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    outputs:
      title-valid: ${{ steps.check-title.outputs.valid }}
      body-valid: ${{ steps.check-body.outputs.valid }}

    permissions:
      issues: write
      pull-requests: write

    steps:
      - name: 🔒 Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: 📥 Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🔍 Check PR Title
        id: check-title
        uses: actions/github-script@v7
        with:
          script: |
            const core = require('@actions/core');
            const github = require('@actions/github');

            try {
              const title = github.context.payload.pull_request?.title || '';
              // Enclose the regex in double quotes and escape special characters
              const conventionalCommitRegex = "^(build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test)(\\([\\w-]+\\))?: .{1,100}$";

              const regex = new RegExp(conventionalCommitRegex); // Create a RegExp object

              const isValid = regex.test(title);
              core.setOutput('valid', isValid);

              if (!isValid) {
                const validTypes = ['build', 'chore', 'ci', 'docs', 'feat', 'fix', 'perf', 'refactor', 'revert', 'style', 'test'];

                await github.rest.issues.createComment({
                  owner: github.context.repo.owner,
                  repo: github.context.repo.repo,
                  issue_number: github.context.issue.number,
                  body: `## ❌ Invalid PR Title

                  Please follow [Conventional Commits](https://www.conventionalcommits.org/) format:
                  \`type(scope): description\`

                  Valid types:
                  ${validTypes.map(type => `- \`${type}\``).join('\n')}

                  Examples:
                  - \`feat(auth): add login functionality\`
                  - \`fix(api): handle null response\`
                  `
                });
              }
            } catch (error) {
              core.error(`An error occurred during PR title validation: ${error.message}`); // Log the error
              core.setOutput('valid', false); // Ensure it's marked as invalid on error
            }

  test:
    name: Python ${{ matrix.python-version }} on ${{ matrix.os }}
    needs: [validate, validate-pr]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        #exclude:
        #  - os: ubuntu-latest  # No longer excluding Ubuntu

    outputs:
      coverage: ${{ steps.coverage.outputs.percentage }}

    steps:
      - name: 🔒 Harden Runner
        uses: step-security/harden-runner@v2 # Use tag instead of SHA
        with:
          egress-policy: audit

      - name: 📥 Checkout Repository
        uses: actions/checkout@v4 # Use tag instead of SHA
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Call Python Environment Setup
        uses: ./.github/actions/python-setup
        with:
          python-version: '3.12'
        id: python-setup

      - name: 🧰 Install Dependencies
        run: |
          hatch env create test

      - name: 🎨 Setup Qt Dependencies
        if: runner.os == 'Linux'
        uses: ./.github/actions/setup-qt-dependencies

      - name: 🧪 Run Tests and Generate Coverage
        id: coverage
        run: |
          - name: 🧪 Run Tests and Generate Coverage
            id: coverage
            run: |
              hatch run test:cov
              # Use xmllint to extract the coverage percentage
              COVERAGE=$(xmllint --xpath "string(//line-rate)" coverage.xml | awk '{print $1 * 100}')
              echo "percentage=${COVERAGE}" >> "$GITHUB_OUTPUT"

              if [ $(echo "${COVERAGE} < 80" | bc -l) -eq 1 ]; then
                echo "::warning::Coverage ${COVERAGE}% is below threshold of 80%"
                exit 1 # Fail the step if coverage is below 80%
              fi

      - name: 📤 Upload Coverage
        uses: codecov/codecov-action@v4 # Use tag instead of SHA
        with:
          files: ./coverage.xml
          flags: ${{ matrix.os }},python-${{ matrix.python-version }}
          fail_ci_if_error: true

      - name: 📦 Store Test Results
        if: always()
        uses: actions/upload-artifact@v4 # Use tag instead of SHA
        with:
          name: test-results-${{ matrix.os }}-${{ matrix.python-version }}
          path: |
            .coverage
            coverage.xml
            htmlcov/
          retention-days: 7

  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      issues: write
      pull-requests: write

    steps:
      - name: 🔒 Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: 📥 Checkout Repository
        uses: actions/checkout@v4

      - name: Call Python Environment Setup
        uses: ./.github/actions/python-setup
        with:
          python-version: '3.x'
        id: python-setup

      - name: ⚙️ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18' # Or your preferred Node.js version

      - name: 🧰 Install Dependencies
        run: |
          hatch env create lint
          npm install # Install Node.js dependencies

      - name: ✨ Run Prettier
        run: npx prettier --write . # Format all files

      - name: ✨ Run Pre-commit Checks
        run: hatch run lint:precommit

  spell-check:
    name: Spell Check
    runs-on: ubuntu-latest
    needs: quality-checks
    timeout-minutes: 15

    steps:
      - name: 🔒 Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: 🧰 Checkout Repository
        uses: actions/checkout@v4

      - name: Call Python Environment Setup
        uses: ./.github/actions/python-setup
        with:
          python-version: '3.x'
        id: python-setup

      - name: ⚙️ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18' # Or your preferred Node.js version

      - name: 🧰 Install Dependencies
        run: |
          hatch env create lint
          npm install # Install Node.js dependencies

      - name: 🔍 Run Spell Checks
        id: spell-check
        run: |
          hatch run lint:spelling

      - name: 🔍 Run CSpell Checks
        id: cspell-check
        run: |
            npx cspell **

      - name: 📝 Create Fix PR
        if: ${{ failure() }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'docs: fix spelling issues'
          title: '📝 Fix spelling issues'
          body: 'Automated PR to fix spelling errors detected by codespell.'
          branch: fix/spelling-${{ github.run_id }}
          delete-branch: true
          labels: |
            documentation
            automated-pr
            spelling

  docs:
    name: Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: test

    steps:
      - name: 🔒 Harden Runner
        uses: step-security/harden-runner@v2 # Use tag instead of SHA
        with:
          egress-policy: audit

      - name: 🧰 Checkout Repository
        uses: actions/checkout@v4

      - name: Call Python Environment Setup
        uses: ./.github/actions/python-setup
        with:
          python-version: '3.x'
          id: python-setup

      - name: 🧰 Install Dependencies
        run: |
          hatch env create docs

      - name: 📚 Build Docs
        id: build
        run: |
          hatch run docs:build

      - name: 🔍 Check Links
        run: hatch run docs:validate-links

      - name: 🔍 Quality Check
        run: python docs/scripts/doc_quality.py
        continue-on-error: true

      - name: 📊 Translation Status
        id: translations
        run: |
          # Assuming you have a script at scripts/translation_status.py
          # that outputs "translation_coverage=<coverage_percentage>"
          python scripts/translation_status.py >> "$GITHUB_OUTPUT" # Changed this line

  report:
    name: Generate Report
    if: always()
    needs: [validate, validate-pr, test, quality-checks, spell-check, docs]
    runs-on: ubuntu-latest

    steps:
      - name: 📊 Process Results
        uses: actions/github-script@v7
        with:
          script: |
            const getResultEmoji = (result) => {
              switch (result) {
                case 'success': return '✅';
                case 'failure': return '❌';
                case 'cancelled': return '🛑';
                case 'skipped': return '⚪';
                default: return '❓';
              }
            };

            const summary = `## 🔍 PR Check Results

            ### Test Coverage: ${process.env.TEST_COVERAGE}%

            - Validate: ${getResultEmoji(process.env.VALIDATE_RESULT)} ${process.env.VALIDATE_RESULT}
            - Validate-PR: ${getResultEmoji(process.env.VALIDATE_PR_RESULT)} ${process.env.VALIDATE_PR_RESULT}
            - Test: ${getResultEmoji(process.env.TEST_RESULT)} ${process.env.TEST_RESULT} (See details below)
            - Quality-Checks: ${getResultEmoji(process.env.QUALITY_CHECKS_RESULT)} ${process.env.QUALITY_CHECKS_RESULT}
            - Spell-Check: ${getResultEmoji(process.env.SPELL_CHECK_RESULT)} ${process.env.SPELL_CHECK_RESULT}
            - Docs: ${getResultEmoji(process.env.DOCS_RESULT)} ${process.env.DOCS_RESULT}

            ### Details
            - [Coverage Report](https://codecov.io/gh/${process.env.REPOSITORY})
            - [Test Results](${process.env.GITHUB_SERVER_URL}/${process.env.REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})
            - Translation Coverage: ${process.env.TRANSLATION_COVERAGE}%
            `;

            if (context.payload.pull_request) {
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.payload.pull_request.number,
                body: summary
              });
            }
        env:
          TEST_COVERAGE: ${{ needs.test.outputs.coverage }}
          VALIDATE_RESULT: ${{ needs.validate.result }}
          VALIDATE_PR_RESULT: ${{ needs.validate-pr.result }}
          TEST_RESULT: ${{ needs.test.result }}
          QUALITY_CHECKS_RESULT: ${{ needs.quality-checks.result }}
          SPELL_CHECK_RESULT: ${{ needs.spell-check.result }}
          DOCS_RESULT: ${{ needs.docs.result }}
          REPOSITORY: ${{ github.repository }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          TRANSLATION_COVERAGE: ${{ needs.docs.outputs.translation_coverage }} #Added this line

      - name: 🚨 Check Status
        if: needs.test.result != 'success' || needs.quality-checks.result != 'success' || needs.docs.result != 'success' || needs.spell-check.result != 'success'
        run: exit 1
